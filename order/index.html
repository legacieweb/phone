<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Complete Your Order - Mysticphones</title>
  <link rel="stylesheet" href="../output.css" />
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css" />
  <script src="https://js.paystack.co/v1/inline.js"></script>
</head>
<body class="bg-slate-50 text-slate-900 font-sans antialiased">
  <!-- Header -->
  <header class="bg-white shadow-sm border-b border-slate-200">
    <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-4">
      <div class="flex justify-between items-center">
        <div class="flex items-center space-x-3">
          <div class="bg-slate-900 p-2 rounded-lg">
            <i class="fas fa-shopping-cart text-white text-xl"></i>
          </div>
          <div>
            <h1 class="text-2xl font-bold text-slate-900">Complete Your Order</h1>
            <p class="text-sm text-slate-600">Secure checkout process</p>
          </div>
        </div>
        <a href="https://phone.iyonicorp.com" class="bg-slate-100 hover:bg-slate-200 text-slate-700 px-4 py-2 rounded-lg font-semibold transition-colors flex items-center space-x-2">
          <i class="fas fa-arrow-left"></i>
          <span>Back to Store</span>
        </a>
      </div>
    </div>
  </header>

  <!-- Progress Indicator -->
  <div class="bg-white border-b border-slate-200">
    <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-4">
      <div class="flex items-center justify-between">
        <div class="flex items-center space-x-4">
          <div class="flex items-center">
            <div class="w-8 h-8 bg-slate-900 text-white rounded-full flex items-center justify-center text-sm font-bold">1</div>
            <span class="ml-2 text-sm font-medium text-slate-900">Cart</span>
          </div>
          <div class="w-8 h-px bg-slate-300"></div>
          <div class="flex items-center">
            <div class="w-8 h-8 bg-slate-900 text-white rounded-full flex items-center justify-center text-sm font-bold">2</div>
            <span class="ml-2 text-sm font-medium text-slate-900">Checkout</span>
          </div>
          <div class="w-8 h-px bg-slate-300"></div>
          <div class="flex items-center">
            <div class="w-8 h-8 bg-slate-400 text-white rounded-full flex items-center justify-center text-sm font-bold">3</div>
            <span class="ml-2 text-sm font-medium text-slate-500">Complete</span>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Main Content -->
  <main class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
    <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
      <!-- Order Form -->
      <div class="lg:col-span-2">
        <div class="bg-white rounded-xl shadow-sm border border-slate-200 p-8">
          <h2 class="text-2xl font-bold text-slate-900 mb-6">Shipping & Payment Information</h2>

          <form id="orderForm" class="space-y-8">
            <!-- Personal Information -->
            <div class="space-y-6">
              <h3 class="text-lg font-semibold text-slate-900 border-b border-slate-200 pb-2">
                <i class="fas fa-user mr-2 text-slate-600"></i>Personal Details
              </h3>

              <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                <div>
                  <label class="block text-sm font-medium text-slate-700 mb-2">Full Name</label>
                  <input type="text" id="fullName" required
                         class="w-full px-4 py-3 rounded-lg border border-slate-300 focus:ring-2 focus:ring-slate-500 focus:border-transparent transition-all" placeholder="Enter your full name" />
                </div>
                <div>
                  <label class="block text-sm font-medium text-slate-700 mb-2">Phone Number</label>
                  <input type="tel" id="phoneNumber" required
                         class="w-full px-4 py-3 rounded-lg border border-slate-300 focus:ring-2 focus:ring-slate-500 focus:border-transparent transition-all" placeholder="+1 (234) 567-8900" />
                </div>
              </div>
            </div>

            <!-- Shipping Address -->
            <div class="space-y-6">
              <h3 class="text-lg font-semibold text-slate-900 border-b border-slate-200 pb-2">
                <i class="fas fa-map-marker-alt mr-2 text-slate-600"></i>Shipping Address
              </h3>

              <div>
                <label class="block text-sm font-medium text-slate-700 mb-2">Street Address</label>
                <textarea id="physicalAddress" required rows="3"
                          class="w-full px-4 py-3 rounded-lg border border-slate-300 focus:ring-2 focus:ring-slate-500 focus:border-transparent transition-all resize-none" placeholder="Street address, apartment, suite, etc."></textarea>
              </div>

              <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                <div>
                  <label class="block text-sm font-medium text-slate-700 mb-2">Country</label>
                  <select id="country" class="w-full px-4 py-3 rounded-lg border border-slate-300 focus:ring-2 focus:ring-slate-500 focus:border-transparent transition-all" required>
                    <option value="">Select Country</option>
                  </select>
                </div>
                <div>
                  <label class="block text-sm font-medium text-slate-700 mb-2">State/Province</label>
                  <select id="state" class="w-full px-4 py-3 rounded-lg border border-slate-300 focus:ring-2 focus:ring-slate-500 focus:border-transparent transition-all" required>
                    <option value="">Select State</option>
                  </select>
                </div>
                <div>
                  <label class="block text-sm font-medium text-slate-700 mb-2">City</label>
                  <select id="county" class="w-full px-4 py-3 rounded-lg border border-slate-300 focus:ring-2 focus:ring-slate-500 focus:border-transparent transition-all" required>
                    <option value="">Select City</option>
                  </select>
                </div>
              </div>
            </div>

            <!-- Payment Method -->
            <div class="space-y-6">
              <h3 class="text-lg font-semibold text-slate-900 border-b border-slate-200 pb-2">
                <i class="fas fa-credit-card mr-2 text-slate-600"></i>Payment Method
              </h3>

              <div class="space-y-4">
                <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                  <label class="relative">
                    <input type="radio" name="payment" value="cash" class="sr-only peer" required />
                    <div class="p-4 border-2 border-slate-200 rounded-lg cursor-pointer peer-checked:border-slate-900 peer-checked:bg-slate-50 transition-all">
                      <div class="flex items-center">
                        <i class="fas fa-money-bill-wave text-2xl text-slate-600 mr-3"></i>
                        <div>
                          <div class="font-semibold text-slate-900">Cash on Delivery</div>
                          <div class="text-sm text-slate-600">Pay when you receive</div>
                        </div>
                      </div>
                    </div>
                  </label>

                  <label class="relative">
                    <input type="radio" name="payment" value="mobile" class="sr-only peer" />
                    <div class="p-4 border-2 border-slate-200 rounded-lg cursor-pointer peer-checked:border-slate-900 peer-checked:bg-slate-50 transition-all">
                      <div class="flex items-center">
                        <i class="fas fa-mobile-alt text-2xl text-slate-600 mr-3"></i>
                        <div>
                          <div class="font-semibold text-slate-900">Mobile Money</div>
                          <div class="text-sm text-slate-600">M-Pesa, Airtel Money</div>
                        </div>
                      </div>
                    </div>
                  </label>

                  <label class="relative">
                    <input type="radio" name="payment" value="card" class="sr-only peer" />
                    <div class="p-4 border-2 border-slate-200 rounded-lg cursor-pointer peer-checked:border-slate-900 peer-checked:bg-slate-50 transition-all">
                      <div class="flex items-center">
                        <i class="fas fa-credit-card text-2xl text-slate-600 mr-3"></i>
                        <div>
                          <div class="font-semibold text-slate-900">Credit/Debit Card</div>
                          <div class="text-sm text-slate-600">Visa, Mastercard</div>
                        </div>
                      </div>
                    </div>
                  </label>
                </div>

                <div class="bg-blue-50 border border-blue-200 rounded-lg p-4">
                  <label class="flex items-center">
                    <input type="checkbox" id="cod" class="w-4 h-4 text-blue-600 bg-slate-100 border-slate-300 rounded focus:ring-blue-500" checked />
                    <span class="ml-3 text-sm text-blue-900 font-medium">Payment on Delivery</span>
                  </label>
                  <p class="text-xs text-blue-700 mt-1">Pay only when your order arrives at your doorstep</p>
                </div>
              </div>
            </div>

            <!-- Submit Button -->
            <div class="pt-6 border-t border-slate-200">
              <button type="submit" id="submitBtn" class="w-full bg-slate-900 hover:bg-slate-800 text-white py-4 rounded-lg font-semibold transition-colors flex items-center justify-center space-x-2">
                <i class="fas fa-lock"></i>
                <span>Complete Order</span>
              </button>
            </div>
          </form>
        </div>
      </div>

      <!-- Order Summary -->
      <div class="lg:col-span-1">
        <div class="bg-white rounded-xl shadow-sm border border-slate-200 p-6 sticky top-6">
          <h3 class="text-lg font-bold text-slate-900 mb-6">Order Summary</h3>

          <div id="orderContainer" class="space-y-4">
            <!-- Order item will be populated by JS -->
          </div>

          <!-- Order Total -->
          <div class="border-t border-slate-200 pt-4 mt-6">
            <div class="flex justify-between items-center text-lg font-bold text-slate-900">
              <span>Total</span>
              <span id="orderTotal">$0.00</span>
            </div>
          </div>

          <!-- Security Notice -->
          <div class="mt-6 p-4 bg-green-50 border border-green-200 rounded-lg">
            <div class="flex items-center">
              <i class="fas fa-shield-alt text-green-600 mr-3"></i>
              <div>
                <div class="text-sm font-medium text-green-900">Secure Checkout</div>
                <div class="text-xs text-green-700">SSL encrypted payment processing</div>
              </div>
            </div>
          </div>

          <!-- Delivery Info -->
          <div class="mt-4 p-4 bg-blue-50 border border-blue-200 rounded-lg">
            <div class="flex items-center">
              <i class="fas fa-truck text-blue-600 mr-3"></i>
              <div>
                <div class="text-sm font-medium text-blue-900">Free Delivery</div>
                <div class="text-xs text-blue-700">2-5 business days delivery</div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </main>

  <!-- Success Modal -->
  <div id="successModal" class="fixed inset-0 bg-black/60 hidden z-50 flex items-center justify-center p-4">
    <div class="bg-white rounded-2xl p-8 w-full max-w-md shadow-2xl text-center">
      <div class="w-16 h-16 bg-green-100 rounded-full flex items-center justify-center mx-auto mb-4">
        <i class="fas fa-check-circle text-green-600 text-3xl"></i>
      </div>
      <h2 class="text-2xl font-bold text-slate-900 mb-2">Order Placed Successfully!</h2>
      <p class="text-slate-600 mb-6">Thank you for your purchase. We'll send you a confirmation email shortly.</p>
      <div class="space-y-3">
        <a href="./dashboard" class="block w-full bg-slate-900 hover:bg-slate-800 text-white py-3 rounded-lg font-semibold transition-colors">
          View My Orders
        </a>
        <a href="https://phone.iyonicorp.com" class="block w-full bg-slate-100 hover:bg-slate-200 text-slate-700 py-3 rounded-lg font-semibold transition-colors">
          Continue Shopping
        </a>
      </div>
    </div>
  </div>

  <script>
    const userEmail = localStorage.getItem("userEmail");
    if (!userEmail) {
      alert("You must be logged in to view the order page.");
      window.location.href = "https://phone.iyonicorp.com";
    }

    const orderItem = JSON.parse(localStorage.getItem("orderItem"));
    const container = document.getElementById("orderContainer");
    const orderTotal = document.getElementById("orderTotal");

    if (!orderItem) {
      container.innerHTML = `
        <div class="text-center py-8">
          <i class="fas fa-exclamation-triangle text-4xl text-red-500 mb-4"></i>
          <p class="text-red-600 font-medium">No product selected</p>
          <p class="text-slate-600 text-sm">Please go back and choose a phone to order.</p>
        </div>
      `;
    } else {
      container.innerHTML = `
        <div class="flex items-center space-x-4 p-4 bg-slate-50 rounded-lg">
          <img src="${orderItem.image}" class="w-16 h-16 object-cover rounded-lg" />
          <div class="flex-1">
            <h4 class="font-semibold text-slate-900">${orderItem.name}</h4>
            <p class="text-sm text-slate-600">Quantity: 1</p>
          </div>
          <div class="text-right">
            <div class="font-bold text-slate-900">$${orderItem.price}</div>
          </div>
        </div>
      `;
      orderTotal.textContent = `$${orderItem.price}`;
    }

    const locationData = {
      "USA": {
        "California": {
          "Los Angeles": [],
          "San Diego": [],
          "San Francisco": []
        },
        "New York": {
          "New York City": [],
          "Buffalo": []
        }
      },
      "UK": {
        "England": {
          "London": [],
          "Manchester": []
        },
        "Scotland": {
          "Edinburgh": [],
          "Glasgow": []
        }
      },
      "Australia": {
        "New South Wales": {
          "Sydney": [],
          "Newcastle": []
        },
        "Victoria": {
          "Melbourne": []
        }
      },
      "Kenya": {
        "Nairobi": {
          "Westlands": [],
          "Kilimani": [],
          "Karen": []
        },
        "Mombasa": {
          "Mombasa CBD": []
        }
      }
    };

    const countrySelect = document.getElementById("country");
    const stateSelect = document.getElementById("state");
    const countySelect = document.getElementById("county");

    function populate(select, items) {
      select.innerHTML = '<option value="">Select...</option>';
      for (let item of Object.keys(items)) {
        let opt = document.createElement("option");
        opt.value = item;
        opt.textContent = item;
        select.appendChild(opt);
      }
    }

    countrySelect.addEventListener("change", () => {
      const states = locationData[countrySelect.value];
      populate(stateSelect, states || {});
      populate(countySelect, {});
    });

    stateSelect.addEventListener("change", () => {
      const counties = locationData[countrySelect.value]?.[stateSelect.value];
      populate(countySelect, counties || {});
    });

    // Payment method logic
    document.querySelectorAll('input[name="payment"]').forEach(input => {
      input.addEventListener("change", () => {
        const cod = document.getElementById("cod");
        if (input.value === "cash") {
          cod.checked = true;
          cod.disabled = true;
        } else {
          cod.disabled = false;
          cod.checked = input.value === "card";
        }
      });
    });

    // Load initial values
    window.addEventListener("DOMContentLoaded", async () => {
      populate(countrySelect, locationData);

      try {
        const res = await fetch(`https://phone-tzua.onrender.com/api/user/${userEmail}`);
        const user = await res.json();
        if (user) {
          document.getElementById("fullName").value = user.name || "";
          document.getElementById("phoneNumber").value = user.phone || "";
        }
      } catch (err) {
        console.warn("Failed to fetch user info:", err);
      }
    });

    // Submit logic
    document.getElementById("orderForm").addEventListener("submit", async (e) => {
      e.preventDefault();
      const submitBtn = document.getElementById("submitBtn");
      submitBtn.disabled = true;
      submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i>Processing...';

      const name = document.getElementById("fullName").value;
      const phone = document.getElementById("phoneNumber").value;
      const physicalAddress = document.getElementById("physicalAddress").value;
      const payment = document.querySelector('input[name="payment"]:checked')?.value;
      const paymentOnDelivery = document.getElementById("cod").checked;

      if (!payment) {
        alert("Please select a payment method.");
        submitBtn.disabled = false;
        submitBtn.innerHTML = '<i class="fas fa-lock mr-2"></i>Complete Order';
        return;
      }

      const address = `${physicalAddress}, ${countySelect.value}, ${stateSelect.value}, ${countrySelect.value}`;

      const orderData = {
        name,
        phone,
        address,
        email: userEmail,
        product: orderItem.name,
        price: orderItem.price,
        image: orderItem.image,
        payment,
        paymentOnDelivery
      };

      const finalize = () => {
        submitBtn.disabled = false;
        submitBtn.innerHTML = '<i class="fas fa-lock mr-2"></i>Complete Order';
      }

      if (payment === 'mobile' && !paymentOnDelivery) {
        payWithPaystack(orderData, 'KES', finalize);
      } else if (payment === 'card' && !paymentOnDelivery) {
        payWithPaystack(orderData, 'USD', finalize);
      } else {
        await sendOrderToBackend(orderData);
        finalize();
      }
    });

    function payWithPaystack(order, currency = 'USD', onComplete) {
      const conversionRates = { 'USD': 1, 'KES': 120 };
      const convertedAmount = Math.round(order.price * conversionRates[currency]);

      const handler = PaystackPop.setup({
        key: 'pk_test_232531a5c927ef2cc67ed1b85af3f26e3b8ed2f2',
        email: order.email,
        amount: convertedAmount * 100,
        currency: currency,
        callback: function(response) {
          showNotification(`Payment successful (${currency}). Ref: ${response.reference}`, 'success');
          if (currency === 'KES') {
            order.price = Math.round(convertedAmount / conversionRates['KES']);
          }
          sendOrderToBackend(order).then(onComplete);
        },
        onClose: function() {
          showNotification('Payment window closed or canceled.', 'warning');
          if (typeof onComplete === 'function') onComplete();
        }
      });
      handler.openIframe();
    }

    async function sendOrderToBackend(order) {
      try {
        await fetch("https://phone-tzua.onrender.com/api/order", {
          method: "POST",
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(order)
        });

        // Show success modal
        document.getElementById('successModal').classList.remove('hidden');
      } catch (err) {
        console.error("‚ùå Failed to place order:", err);
        showNotification("Failed to place order. Please try again.", 'error');
      }
    }

    function showNotification(message, type = 'info') {
      const notification = document.createElement('div');
      notification.className = `fixed top-4 right-4 z-50 p-4 rounded-lg shadow-lg max-w-sm ${
        type === 'success' ? 'bg-green-500' :
        type === 'error' ? 'bg-red-500' :
        type === 'warning' ? 'bg-yellow-500' : 'bg-blue-500'
      } text-white`;
      notification.innerHTML = `
        <div class="flex items-center">
          <i class="fas ${
            type === 'success' ? 'fa-check-circle' :
            type === 'error' ? 'fa-exclamation-circle' :
            type === 'warning' ? 'fa-exclamation-triangle' : 'fa-info-circle'
          } mr-2"></i>
          <span class="text-sm">${message}</span>
        </div>
      `;

      document.body.appendChild(notification);

      setTimeout(() => {
        notification.remove();
      }, 4000);
    }
  </script>
</body>
</html>
