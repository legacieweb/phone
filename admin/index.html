<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Admin Panel - Mysticphones</title>
  <link rel="stylesheet" href="../output.css" />
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css" />
</head>
<body class="bg-slate-50 text-slate-900 font-sans antialiased">
  <!-- Header -->
  <header class="bg-white shadow-sm border-b border-slate-200">
    <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-4">
      <div class="flex justify-between items-center">
        <div class="flex items-center space-x-3">
          <div class="bg-slate-900 p-2 rounded-lg">
            <i class="fas fa-cog text-white text-xl"></i>
          </div>
          <div>
            <h1 class="text-2xl font-bold text-slate-900">Mysticphones Admin</h1>
            <p class="text-sm text-slate-600">Management Dashboard</p>
          </div>
        </div>
        <button onclick="logout()" class="bg-red-600 hover:bg-red-700 text-white px-4 py-2 rounded-lg font-semibold transition-colors flex items-center space-x-2">
          <i class="fas fa-sign-out-alt"></i>
          <span>Logout</span>
        </button>
      </div>
    </div>
  </header>

  <!-- Login Modal -->
  <div id="loginModal" class="fixed inset-0 bg-black/60 flex items-center justify-center z-50 p-4">
    <div class="bg-white rounded-2xl p-8 w-full max-w-md shadow-2xl">
      <div class="text-center mb-6">
        <div class="bg-slate-900 w-16 h-16 rounded-full flex items-center justify-center mx-auto mb-4">
          <i class="fas fa-lock text-white text-2xl"></i>
        </div>
        <h2 class="text-2xl font-bold text-slate-900">Admin Access</h2>
        <p class="text-slate-600 mt-2">Enter your credentials to continue</p>
      </div>

      <form onsubmit="verifyPassword(); return false;" class="space-y-4">
        <div>
          <label class="block text-sm font-medium text-slate-700 mb-1">Username</label>
          <input id="adminUsername" type="text" placeholder="Enter username"
                 class="w-full px-4 py-3 rounded-lg border border-slate-300 focus:ring-2 focus:ring-slate-500 focus:border-transparent transition-all" />
        </div>

        <div>
          <label class="block text-sm font-medium text-slate-700 mb-1">Password</label>
          <input id="adminPassword" type="password" placeholder="Enter password"
                 class="w-full px-4 py-3 rounded-lg border border-slate-300 focus:ring-2 focus:ring-slate-500 focus:border-transparent transition-all" />
        </div>

        <button type="submit" class="w-full bg-slate-900 hover:bg-slate-800 text-white py-3 rounded-lg font-semibold transition-colors">
          Access Admin Panel
        </button>

        <p id="loginError" class="text-sm text-red-600 text-center hidden">
          <i class="fas fa-exclamation-triangle mr-1"></i>
          Invalid credentials. Please try again.
        </p>
      </form>
    </div>
  </div>

  <!-- Main Content -->
  <main class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
    <!-- Stats Cards -->
    <div class="grid grid-cols-1 md:grid-cols-4 gap-6 mb-8">
      <div class="bg-white p-6 rounded-xl shadow-sm border border-slate-200">
        <div class="flex items-center justify-between">
          <div>
            <p class="text-sm text-slate-600">Total Orders</p>
            <p class="text-2xl font-bold text-slate-900" id="totalOrders">0</p>
          </div>
          <div class="bg-blue-100 p-3 rounded-lg">
            <i class="fas fa-shopping-cart text-blue-600 text-xl"></i>
          </div>
        </div>
      </div>

      <div class="bg-white p-6 rounded-xl shadow-sm border border-slate-200">
        <div class="flex items-center justify-between">
          <div>
            <p class="text-sm text-slate-600">Pending Orders</p>
            <p class="text-2xl font-bold text-orange-600" id="pendingOrders">0</p>
          </div>
          <div class="bg-orange-100 p-3 rounded-lg">
            <i class="fas fa-clock text-orange-600 text-xl"></i>
          </div>
        </div>
      </div>

      <div class="bg-white p-6 rounded-xl shadow-sm border border-slate-200">
        <div class="flex items-center justify-between">
          <div>
            <p class="text-sm text-slate-600">Total Users</p>
            <p class="text-2xl font-bold text-slate-900" id="totalUsers">0</p>
          </div>
          <div class="bg-green-100 p-3 rounded-lg">
            <i class="fas fa-users text-green-600 text-xl"></i>
          </div>
        </div>
      </div>

      <div class="bg-white p-6 rounded-xl shadow-sm border border-slate-200">
        <div class="flex items-center justify-between">
          <div>
            <p class="text-sm text-slate-600">Revenue</p>
            <p class="text-2xl font-bold text-green-600" id="totalRevenue">$0</p>
          </div>
          <div class="bg-green-100 p-3 rounded-lg">
            <i class="fas fa-dollar-sign text-green-600 text-xl"></i>
          </div>
        </div>
      </div>
    </div>

    <!-- Orders Section -->
    <div class="bg-white rounded-xl shadow-sm border border-slate-200 mb-8">
      <div class="p-6 border-b border-slate-200">
        <div class="flex items-center justify-between">
          <div class="flex items-center space-x-3">
            <i class="fas fa-box text-slate-600 text-xl"></i>
            <h2 class="text-xl font-bold text-slate-900">Order Management</h2>
          </div>
          <div class="flex space-x-2">
            <button onclick="fetchAdminData()" class="bg-slate-100 hover:bg-slate-200 text-slate-700 px-4 py-2 rounded-lg transition-colors">
              <i class="fas fa-sync-alt mr-2"></i>Refresh
            </button>
          </div>
        </div>
      </div>

      <div class="overflow-x-auto">
        <table class="w-full">
          <thead class="bg-slate-50">
            <tr>
              <th class="px-6 py-4 text-left text-xs font-semibold text-slate-600 uppercase tracking-wider">Order ID</th>
              <th class="px-6 py-4 text-left text-xs font-semibold text-slate-600 uppercase tracking-wider">Customer</th>
              <th class="px-6 py-4 text-left text-xs font-semibold text-slate-600 uppercase tracking-wider">Product</th>
              <th class="px-6 py-4 text-left text-xs font-semibold text-slate-600 uppercase tracking-wider">Amount</th>
              <th class="px-6 py-4 text-left text-xs font-semibold text-slate-600 uppercase tracking-wider">Status</th>
              <th class="px-6 py-4 text-left text-xs font-semibold text-slate-600 uppercase tracking-wider">Date</th>
              <th class="px-6 py-4 text-left text-xs font-semibold text-slate-600 uppercase tracking-wider">Actions</th>
            </tr>
          </thead>
          <tbody id="ordersTable" class="divide-y divide-slate-200">
            <!-- Orders will be populated here -->
          </tbody>
        </table>
      </div>

      <div class="p-6 text-center text-slate-500" id="ordersEmpty">
        <i class="fas fa-inbox text-4xl mb-4"></i>
        <p>No orders found</p>
      </div>
    </div>

    <!-- Users Section -->
    <div class="bg-white rounded-xl shadow-sm border border-slate-200">
      <div class="p-6 border-b border-slate-200">
        <div class="flex items-center justify-between">
          <div class="flex items-center space-x-3">
            <i class="fas fa-users text-slate-600 text-xl"></i>
            <h2 class="text-xl font-bold text-slate-900">User Management</h2>
          </div>
        </div>
      </div>

      <div class="overflow-x-auto">
        <table class="w-full">
          <thead class="bg-slate-50">
            <tr>
              <th class="px-6 py-4 text-left text-xs font-semibold text-slate-600 uppercase tracking-wider">Name</th>
              <th class="px-6 py-4 text-left text-xs font-semibold text-slate-600 uppercase tracking-wider">Email</th>
              <th class="px-6 py-4 text-left text-xs font-semibold text-slate-600 uppercase tracking-wider">Phone</th>
              <th class="px-6 py-4 text-left text-xs font-semibold text-slate-600 uppercase tracking-wider">Status</th>
              <th class="px-6 py-4 text-left text-xs font-semibold text-slate-600 uppercase tracking-wider">Joined</th>
              <th class="px-6 py-4 text-left text-xs font-semibold text-slate-600 uppercase tracking-wider">Actions</th>
            </tr>
          </thead>
          <tbody id="usersTable" class="divide-y divide-slate-200">
            <!-- Users will be populated here -->
          </tbody>
        </table>
      </div>

      <div class="p-6 text-center text-slate-500" id="usersEmpty">
        <i class="fas fa-users text-4xl mb-4"></i>
        <p>No users found</p>
      </div>
    </div>
  </main>

  <script>
    async function fetchAdminData() {
      try {
        const [ordersRes, usersRes] = await Promise.all([
          fetch('https://phone-tzua.onrender.com/api/admin/orders'),
          fetch('https://phone-tzua.onrender.com/api/admin/users')
        ]);

        const orders = await ordersRes.json();
        const users = await usersRes.json();

        updateStats(orders, users);
        renderOrders(orders);
        renderUsers(users);
      } catch (error) {
        console.error("❌ Failed to load data:", error);
        alert("Failed to load admin data. Please check your connection.");
      }
    }

    function updateStats(orders, users) {
      document.getElementById('totalOrders').textContent = orders.length;
      document.getElementById('pendingOrders').textContent = orders.filter(o => o.status === 'pending').length;
      document.getElementById('totalUsers').textContent = users.length;

      const totalRevenue = orders.reduce((sum, order) => sum + parseFloat(order.price || 0), 0);
      document.getElementById('totalRevenue').textContent = `$${totalRevenue.toFixed(2)}`;
    }

    function renderOrders(orders) {
      const tbody = document.getElementById('ordersTable');
      const empty = document.getElementById('ordersEmpty');

      if (!orders || orders.length === 0) {
        tbody.innerHTML = '';
        empty.style.display = 'block';
        return;
      }

      empty.style.display = 'none';

      tbody.innerHTML = orders.map(order => `
        <tr class="hover:bg-slate-50 transition-colors">
          <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-slate-900">
            ${order._id?.slice(-8) || 'N/A'}
          </td>
          <td class="px-6 py-4 whitespace-nowrap text-sm text-slate-900">
            ${order.email || 'N/A'}
          </td>
          <td class="px-6 py-4 whitespace-nowrap text-sm text-slate-900">
            ${order.product || 'N/A'}
          </td>
          <td class="px-6 py-4 whitespace-nowrap text-sm text-slate-900">
            $${order.price || '0'}
          </td>
          <td class="px-6 py-4 whitespace-nowrap">
            <span class="inline-flex px-2 py-1 text-xs font-semibold rounded-full ${
              order.status === 'shipped' ? 'bg-green-100 text-green-800' :
              order.status === 'pending delivery' ? 'bg-blue-100 text-blue-800' :
              order.status === 'confirmed' ? 'bg-yellow-100 text-yellow-800' :
              order.status === 'on the way' ? 'bg-purple-100 text-purple-800' :
              'bg-gray-100 text-gray-800'
            }">
              ${order.status || 'pending'}
            </span>
          </td>
          <td class="px-6 py-4 whitespace-nowrap text-sm text-slate-500">
            ${order.createdAt ? new Date(order.createdAt).toLocaleDateString() : 'N/A'}
          </td>
          <td class="px-6 py-4 whitespace-nowrap text-sm">
            <select onchange="updateStatus('${order._id}', this.value)"
                    class="bg-white border border-slate-300 rounded-md px-3 py-1 text-sm focus:ring-2 focus:ring-slate-500 focus:border-transparent">
              ${["pending", "confirmed", "pending delivery", "on the way", "shipped", "cancelled"].map(s => `
                <option value="${s}" ${order.status === s ? "selected" : ""}>${s}</option>
              `).join('')}
            </select>
          </td>
        </tr>
      `).join('');
    }

    function renderUsers(users) {
      const tbody = document.getElementById('usersTable');
      const empty = document.getElementById('usersEmpty');

      if (!users || users.length === 0) {
        tbody.innerHTML = '';
        empty.style.display = 'block';
        return;
      }

      empty.style.display = 'none';

      tbody.innerHTML = users.map(user => `
        <tr class="hover:bg-slate-50 transition-colors">
          <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-slate-900">
            ${user.name || 'N/A'}
          </td>
          <td class="px-6 py-4 whitespace-nowrap text-sm text-slate-900">
            ${user.email || 'N/A'}
          </td>
          <td class="px-6 py-4 whitespace-nowrap text-sm text-slate-500">
            ${user.phone || 'N/A'}
          </td>
          <td class="px-6 py-4 whitespace-nowrap">
            <span class="inline-flex px-2 py-1 text-xs font-semibold rounded-full ${
              user.suspended ? 'bg-red-100 text-red-800' : 'bg-green-100 text-green-800'
            }">
              ${user.suspended ? 'Suspended' : 'Active'}
            </span>
          </td>
          <td class="px-6 py-4 whitespace-nowrap text-sm text-slate-500">
            ${user.createdAt ? new Date(user.createdAt).toLocaleDateString() : 'N/A'}
          </td>
          <td class="px-6 py-4 whitespace-nowrap text-sm">
            <button onclick="toggleSuspend('${user._id}', ${!user.suspended})"
                    class="inline-flex items-center px-3 py-1 rounded-md text-sm font-medium transition-colors ${
                      user.suspended
                        ? 'bg-green-100 text-green-700 hover:bg-green-200'
                        : 'bg-red-100 text-red-700 hover:bg-red-200'
                    }">
              <i class="fas ${user.suspended ? 'fa-user-check' : 'fa-user-times'} mr-1"></i>
              ${user.suspended ? 'Unsuspend' : 'Suspend'}
            </button>
          </td>
        </tr>
      `).join('');
    }

    async function toggleSuspend(userId, suspend) {
      try {
        const res = await fetch(`https://phone-tzua.onrender.com/api/admin/user/${userId}/suspend`, {
          method: 'PUT',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ suspend })
        });

        if (!res.ok) {
          throw new Error('Failed to update user status');
        }

        await fetchAdminData();
        showNotification(suspend ? 'User suspended successfully' : 'User unsuspended successfully', 'success');
      } catch (err) {
        console.error("❌ Suspension Error:", err);
        showNotification('Failed to update user status', 'error');
      }
    }

    async function updateStatus(id, status) {
      try {
        const res = await fetch(`https://phone-tzua.onrender.com/api/admin/order/${id}/status`, {
          method: 'PUT',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ status })
        });

        if (!res.ok) {
          const errData = await res.json();
          throw new Error(errData.error || 'Unable to update status');
        }

        await fetchAdminData();
        showNotification(`Order status updated to ${status}`, 'success');
      } catch (err) {
        console.error("Update Error:", err);
        showNotification('Failed to update order status', 'error');
      }
    }

    function showNotification(message, type = 'info') {
      // Simple notification - you could enhance this with a proper toast system
      const notification = document.createElement('div');
      notification.className = `fixed top-4 right-4 z-50 p-4 rounded-lg shadow-lg ${
        type === 'success' ? 'bg-green-500' :
        type === 'error' ? 'bg-red-500' : 'bg-blue-500'
      } text-white`;
      notification.innerHTML = `
        <div class="flex items-center">
          <i class="fas ${
            type === 'success' ? 'fa-check-circle' :
            type === 'error' ? 'fa-exclamation-circle' : 'fa-info-circle'
          } mr-2"></i>
          ${message}
        </div>
      `;

      document.body.appendChild(notification);

      setTimeout(() => {
        notification.remove();
      }, 3000);
    }

    function logout() {
      if (confirm('Are you sure you want to logout?')) {
        alert("Admin logged out.");
        window.location.href = "https://phone.iyonicorp.com";
      }
    }

    async function verifyPassword() {
      const password = document.getElementById('adminPassword').value;
      const username = document.getElementById('adminUsername').value;

      if (!password || !username) {
        document.getElementById('loginError').classList.remove('hidden');
        return;
      }

      try {
        const res = await fetch('https://phone-tzua.onrender.com/api/admin/login', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            username: username,
            password: password
          })
        });

        if (res.ok) {
          document.getElementById('loginModal').style.display = 'none';
          document.querySelector('main').style.display = 'block';
          await fetchAdminData();
        } else {
          document.getElementById('loginError').classList.remove('hidden');
        }
      } catch (error) {
        console.error('Login error:', error);
        document.getElementById('loginError').classList.remove('hidden');
      }
    }

    // Initialize
    document.addEventListener('DOMContentLoaded', function() {
      // Show login modal initially
      document.getElementById('loginModal').style.display = 'flex';
      document.querySelector('main').style.display = 'none';
    });
  </script>
</body>
</html>
